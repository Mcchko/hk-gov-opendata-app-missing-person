<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤±è¹¤äººå£«æŸ¥è©¢ç³»çµ±</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Awesome Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
    <style>
        .element-hidden {
            display: none !important;
        }

        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 16px;
            color: #f1f5f9;
        }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(30, 41, 59, 0.95);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            color: #ffffff;
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
        }

        .map-section {
            flex: 0 0 60%;
        }

        .data-section {
            flex: 0 0 40%;
            background: rgba(30, 41, 59, 0.95);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            max-height: 73vh;
        }

        /* Map Section */
        .map-container {
            height: 73vh !important;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
            border-radius: 16px;
        }

        /* Data Section Styles */
        .data-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .data-header h2 {
            color: #ffffff;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .data-header .subtitle {
            color: #94a3b8;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .data-stats {
            display: flex;
            justify-content: space-around;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #60a5fa;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #cbd5e1;
        }

        .accordion-container {
            margin-top: 20px;
        }

        .person-item {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .person-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .person-header {
            background: #1e40af;
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .person-header.active {
            background: #3b82f6;
            color: white;
        }

        .person-header i {
            transition: transform 0.3s ease;
        }

        .person-header.collapsed i {
            transform: rotate(-90deg);
        }

        .person-content {
            padding: 15px;
            background: rgba(15, 23, 42, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-row {
            display: flex;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-label {
            font-weight: 600;
            color: #60a5fa;
            width: 150px;
            flex-shrink: 0;
        }

        .info-value {
            flex: 1;
            color: #cbd5e1;
            word-break: break-word;
        }

        .info-value a {
            color: #3b82f6;
            text-decoration: none;
        }

        .info-value a:hover {
            text-decoration: underline;
        }

        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #60a5fa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Person specific styles */
        .person-icon {
            color: #60a5fa;
            margin-right: 8px;
        }

        .case-badge {
            background: #dc2626;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .gender-badge {
            background: #7c3aed;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Marker styles */
        .person-marker {
            background: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .person-marker.selected {
            background: #ef4444;
            width: 20px;
            height: 20px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Gender group styles */
        .gender-group {
            margin-bottom: 16px;
        }

        .gender-header {
            background: #7c3aed !important;
            color: white !important;
            border-radius: 8px 8px 0 0;
        }

        .gender-content {
            background: rgba(15, 23, 42, 0.9);
            padding: 10px;
            border-radius: 0 0 8px 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
        }

        .gender-header:hover {
            background: #6d28d9 !important;
        }

        /* Person image styles */
        .person-image {
            width: 120px;
            height: 160px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #3b82f6;
            margin: 10px 0;
        }

        .image-container {
            text-align: center;
            margin: 10px 0;
        }

        /* Footer */
        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.875rem;
            padding: 20px;
            margin-top: auto;
        }

        /* Last seen info */
        .last-seen {
            background: rgba(220, 38, 38, 0.1);
            border-left: 4px solid #dc2626;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                padding: 12px;
                background: #0f172a;
            }

            .container {
                gap: 16px;
            }

            .header {
                padding: 16px;
                border-radius: 12px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .main-content {
                flex-direction: column;
            }

            .map-section,
            .data-section {
                flex: 1 1 100%;
                width: 100%;
            }

            .map-container {
                height: 400px;
                border-radius: 12px;
            }

            .data-section {
                max-height: 400px;
                padding: 15px;
            }

            .data-header h2 {
                font-size: 1.3rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .info-row {
                flex-direction: column;
                margin-bottom: 15px;
            }

            .info-label {
                width: 100%;
                margin-bottom: 5px;
            }

            .person-header {
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            .person-image {
                width: 100px;
                height: 140px;
            }
        }

        /* Desktop Enhancements */
        @media (min-width: 1200px) {
            .map-container {
                height: 600px;
            }
        }

        /* Leaflet Customizations */
        .leaflet-control-layers {
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
            background: rgba(30, 41, 59, 0.9) !important;
        }

        /* Smooth Transitions */
        * {
            transition: all 0.3s ease;
        }

        /* Police contact info */
        .contact-info {
            background: rgba(34, 197, 94, 0.1);
            border-left: 4px solid #22c55e;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>å¤±è¹¤äººå£«æŸ¥è©¢ç³»çµ±</h1>
            <p class="subtitle">é¦™æ¸¯è­¦å‹™è™•å¤±è¹¤äººå£«è³‡æ–™æŸ¥è©¢åŠä½ç½®è¨˜éŒ„</p>
        </header>
        <main class="main-content">
            <section class="map-section">
                <div class="map-container">
                    <div id="map"></div>
                </div>
            </section>
            <section class="data-section">
                <div class="data-header">
                    <h2>å¤±è¹¤äººå£«åˆ—è¡¨</h2>
                    <p class="subtitle">é»æ“Šå§“åæŸ¥çœ‹è©³ç´°è³‡è¨ŠåŠæœ€å¾Œå‡ºç¾ä½ç½®</p>
                </div>
                <div class="data-stats">
                    <div class="stat-item">
                        <span id="total-cases" class="stat-value">0</span>
                        <span class="stat-label">å¤±è¹¤å€‹æ¡ˆ</span>
                    </div>
                    <div class="stat-item">
                        <span id="male-cases" class="stat-value">0</span>
                        <span class="stat-label">ç”·æ€§</span>
                    </div>
                    <div class="stat-item">
                        <span id="female-cases" class="stat-value">0</span>
                        <span class="stat-label">å¥³æ€§</span>
                    </div>
                    <div class="stat-item">
                        <span id="recent-cases" class="stat-value">0</span>
                        <span class="stat-label">30æ—¥å…§</span>
                    </div>
                </div>
                <div class="accordion-container" id="accordion-container">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>æ­£åœ¨åŠ è¼‰å¤±è¹¤äººå£«è³‡æ–™...</p>
                    </div>
                </div>
            </section>
        </main>
        <footer class="footer">
            <p>å¤±è¹¤äººå£«æŸ¥è©¢ç³»çµ± | è³‡æ–™ä¾†æº: é¦™æ¸¯è­¦å‹™è™• | å¦‚æœ‰ä»»ä½•å¤±è¹¤äººå£«æ¶ˆæ¯ï¼Œè«‹ç«‹å³å ±æ¡ˆæˆ–è‡´é›»é¦™æ¸¯è­¦å‹™è™•</p>
        </footer>
    </div>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        const PROXY_URL = 'https://cors-anywhere.herokuapp.com/';
        // å®šç¾©æ•¸æ“šæº - é¦™æ¸¯è­¦å‹™è™•å¤±è¹¤äººå£«è³‡æ–™
        const DATA_SOURCE_URL = 'https://www.police.gov.hk/info/appeals_public/missing_persons/mp.php?lang=tc';

        // å…¨å±€è®Šé‡
        let map;
        let missingPersons = [];
        let markersLayer = L.layerGroup();
        let selectedMarker = null;
        let totalCases = 0;
        let maleCases = 0;
        let femaleCases = 0;
        let recentCases = 0;

        // åˆå§‹åŒ–åœ°åœ–é…ç½® - ä»¥é¦™æ¸¯ç‚ºä¸­å¿ƒ
        const MAP_CONFIG = {
            center: [22.3193, 114.1694], // é¦™æ¸¯ä¸­å¿ƒé»
            zoom: 12
        };

        // æ¨¡æ“¬é¦™æ¸¯åœ°å€åæ¨™ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰å¾æ•¸æ“šä¸­ç²å–ï¼‰
        const HK_DISTRICT_COORDS = {
            'KW': [22.3193, 114.1694], // ä¹é¾è¥¿
            'KE': [22.3193, 114.1694], // ä¹é¾æ±
            'HK': [22.2783, 114.1747], // é¦™æ¸¯å³¶
            'NT': [22.3964, 114.1095], // æ–°ç•Œ
            'TM': [22.4451, 114.0228]  // å±¯é–€
        };

        // åˆå§‹åŒ–æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', function () {
            initMap();
            loadMissingPersonsData();
        });

        function initMap() {
            // åˆå§‹åŒ–åœ°åœ–
            map = L.map('map', {
                zoomControl: true,
                attributionControl: true
            }).setView(MAP_CONFIG.center, MAP_CONFIG.zoom);

            // æ·»åŠ åœ°åœ–åœ–å±¤
            const tileLayers = {
                "é–‹æ”¾è¡—é“åœ°åœ–": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap',
                    maxZoom: 19,
                    subdomains: ['a', 'b', 'c']
                }),
                "è¡›æ˜Ÿåœ–åƒ": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Â© Esri',
                    maxZoom: 19
                }),
                "åœ°å½¢åœ–": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenTopoMap',
                    maxZoom: 17
                })
            };

            tileLayers["é–‹æ”¾è¡—é“åœ°åœ–"].addTo(map);

            // æ·»åŠ åœ–å±¤æ§åˆ¶
            L.control.layers(tileLayers, null, {
                collapsed: true,
                position: 'topright'
            }).addTo(map);

            // æ·»åŠ æ¨™è¨˜åœ–å±¤
            markersLayer.addTo(map);
        }

        async function loadMissingPersonsData() {
            try {
                const response = await fetch(PROXY_URL + DATA_SOURCE_URL);
                if (response.status == 403) {
                    document.getElementById('accordion-container').innerHTML =
                        '<div class="no-data"><i class="fas fa-exclamation-triangle"></i><p>åŠ è¼‰æ•¸æ“šæ™‚å‡ºéŒ¯ï¼Œè«‹ç¨å¾Œå†è©¦</p></div>';
                    alert(`è«‹å…ˆç€è¦½ "${PROXY_URL}/corsdemo"ï¼Œå•Ÿç”¨ Proxy ä¼ºæœå™¨ã€‚`);
                    showNotification('åŠ è¼‰æ•¸æ“šæ™‚å‡ºéŒ¯ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                    window.open(`${PROXY_URL}`, "_href");
                    return;
                }
                const xmlText = await response.text();

                // è§£æXMLæ•¸æ“š
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'application/xml');
                const cases = xmlDoc.querySelectorAll('case');

                if (cases.length > 0) {
                    missingPersons = Array.from(cases).map(caseElement => {
                        const id = caseElement.getAttribute('id') || '';
                        const date = caseElement.getAttribute('date') || '';
                        const mname = caseElement.querySelector('mname')?.textContent || '';
                        const name2 = caseElement.querySelector('name2')?.textContent || '';
                        const face = caseElement.querySelector('face')?.textContent || '';
                        const mdate = caseElement.querySelector('mdate')?.textContent || '';
                        const reporteddate = caseElement.querySelector('reporteddate')?.textContent || '';
                        const wear = caseElement.querySelector('wear')?.textContent || '';
                        const other = caseElement.querySelector('other')?.textContent || '';
                        const other2 = caseElement.querySelector('other2')?.textContent || '';
                        const sn = caseElement.querySelector('sn')?.textContent || '';
                        const img = caseElement.querySelector('img')?.textContent || '';
                        const img2 = caseElement.querySelector('img2')?.textContent || '';
                        const url = caseElement.querySelector('url')?.textContent || '';
                        const revisedDate = caseElement.querySelector('revisedDate')?.textContent || '';
                        const age = caseElement.querySelector('age')?.textContent || '';
                        const region = caseElement.querySelector('region')?.textContent || '';
                        const gender = caseElement.querySelector('gender')?.textContent || '';

                        return {
                            id,
                            date,
                            mname,
                            name2,
                            face,
                            mdate,
                            reporteddate,
                            wear,
                            other,
                            other2,
                            sn,
                            img: img ? `https://www.police.gov.hk${img}` : '',
                            img2: img2 ? `https://www.police.gov.hk${img2}` : '',
                            url,
                            revisedDate,
                            age,
                            region,
                            gender
                        };
                    });

                    // å‰µå»ºåœ°åœ–æ¨™è¨˜
                    createMarkers(missingPersons);
                    updateStatistics();
                    updatePersonsList(missingPersons);

                    showNotification(`æˆåŠŸåŠ è¼‰ ${missingPersons.length} å®—å¤±è¹¤å€‹æ¡ˆ`, 'success');
                } else {
                    document.getElementById('accordion-container').innerHTML =
                        '<div class="no-data"><i class="fas fa-exclamation-triangle"></i><p>æœªæ‰¾åˆ°å¤±è¹¤äººå£«è³‡æ–™</p></div>';
                }
            } catch (error) {
                console.error('åŠ è¼‰æ•¸æ“šæ™‚å‡ºéŒ¯:', error);
                document.getElementById('accordion-container').innerHTML =
                    '<div class="no-data"><i class="fas fa-exclamation-triangle"></i><p>åŠ è¼‰æ•¸æ“šæ™‚å‡ºéŒ¯</p></div>';
                showNotification('åŠ è¼‰æ•¸æ“šæ™‚å‡ºéŒ¯ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            }
        }

        function createMarkers(persons) {
            markersLayer.clearLayers();

            persons.forEach(person => {
                // æ ¹æ“šåœ°å€ä»£ç¢¼ç²å–åæ¨™ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰æœ‰æ›´æº–ç¢ºçš„ä½ç½®æ•¸æ“šï¼‰
                const region = person.region || 'HK';
                const coordinates = HK_DISTRICT_COORDS[region] || MAP_CONFIG.center;

                // æ ¹æ“šæ€§åˆ¥è¨­ç½®ä¸åŒé¡è‰²çš„æ¨™è¨˜
                let markerColor = '#3b82f6'; // é»˜èªè—è‰²
                if (person.gender && person.gender.includes('å¥³å­')) {
                    markerColor = '#ec4899'; // ç²‰è‰²ä»£è¡¨å¥³æ€§
                }

                // å‰µå»ºè‡ªå®šç¾©æ¨™è¨˜
                const markerIcon = L.divIcon({
                    className: 'person-marker',
                    html: `<div style="background-color: ${markerColor}; width: 100%; height: 100%; border-radius: 50%; border: 2px solid white;"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10],
                    popupAnchor: [0, -10]
                });

                const marker = L.marker(coordinates, {
                    icon: markerIcon,
                    id: person.id
                });

                marker.personData = person;
                marker.bindPopup(createPopupContent(person));

                // é»æ“Šäº‹ä»¶
                marker.on('click', function () {
                    if (selectedMarker) {
                        selectedMarker.setIcon(L.divIcon({
                            className: 'person-marker',
                            html: `<div style="background-color: ${selectedMarker.personData.gender?.includes('å¥³å­') ? '#ec4899' : '#3b82f6'}; width: 100%; height: 100%; border-radius: 50%; border: 2px solid white;"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10],
                            popupAnchor: [0, -10]
                        }));
                    }

                    // è¨­ç½®ç•¶å‰é¸ä¸­çš„æ¨™è¨˜æ¨£å¼
                    marker.setIcon(L.divIcon({
                        className: 'person-marker selected',
                        html: '<div style="background-color: #ef4444; width: 100%; height: 100%; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [25, 25],
                        iconAnchor: [12.5, 12.5],
                        popupAnchor: [0, -12.5]
                    }));

                    selectedMarker = marker;
                    marker.openPopup();
                    map.setView(coordinates, 13, { animate: true });
                    highlightPerson(person.id);
                });

                markersLayer.addLayer(marker);
            });
        }

        function createPopupContent(person) {
            const lastSeenDate = new Date(person.mdate);
            const today = new Date();
            const daysMissing = Math.floor((today - lastSeenDate) / (1000 * 60 * 60 * 24));

            return `
                <div style="max-width: 300px; padding: 10px;">
                    <h3 style="margin: 0 0 10px 0; color: #ef4444;">
                        ${person.mname || 'å§“åä¸è©³'}
                    </h3>
                    ${person.img ? `<div style="text-align: center; margin-bottom: 10px;">
                        <img src="${person.img}" alt="${person.mname}" style="max-width: 100%; max-height: 150px; border-radius: 8px; border: 2px solid #3b82f6;">
                    </div>` : ''}
                    <p style="margin: 5px 0;"><strong>å€‹æ¡ˆç·¨è™Ÿ:</strong> ${person.sn || 'æœªæä¾›'}</p>
                    <p style="margin: 5px 0;"><strong>æ€§åˆ¥/å¹´é½¡:</strong> ${person.gender || 'æœªæä¾›'} / ${person.age || 'æœªæä¾›'}æ­²</p>
                    <p style="margin: 5px 0;"><strong>å¤±è¹¤æ—¥æœŸ:</strong> ${person.mdate || 'æœªæä¾›'}</p>
                    <p style="margin: 5px 0;"><strong>å·²å¤±è¹¤:</strong> ${daysMissing > 0 ? `${daysMissing}å¤©` : 'æœªæä¾›'}</p>
                    <p style="margin: 5px 0;"><strong>å¤–è²Œæè¿°:</strong><br/>${person.face || 'æœªæä¾›'}</p>
                    ${person.other ? `<p style="margin: 5px 0;"><strong>æœ€å¾Œå‡ºç¾:</strong><br/>${person.other}</p>` : ''}
                    <div style="margin-top: 10px; padding: 8px; background: #fef2f2; border-left: 4px solid #dc2626; border-radius: 4px;">
                        <strong>ğŸ“ è¯çµ¡è­¦æ–¹:</strong><br/>
                        <small>${person.other2 || 'è‹¥ä»»ä½•äººæœ‰å¤±è¹¤è€…çš„æ¶ˆæ¯ï¼Œè«‹ç«‹å³é€šçŸ¥è­¦æ–¹'}</small>
                    </div>
                </div>
            `;
        }

        function updateStatistics() {
            totalCases = missingPersons.length;
            maleCases = missingPersons.filter(p => p.gender && p.gender.includes('ç”·å­')).length;
            femaleCases = missingPersons.filter(p => p.gender && p.gender.includes('å¥³å­')).length;

            // è¨ˆç®—30æ—¥å…§çš„å€‹æ¡ˆ
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            recentCases = missingPersons.filter(p => {
                const caseDate = new Date(p.mdate);
                return caseDate >= thirtyDaysAgo;
            }).length;

            document.getElementById('total-cases').textContent = totalCases;
            document.getElementById('male-cases').textContent = maleCases;
            document.getElementById('female-cases').textContent = femaleCases;
            document.getElementById('recent-cases').textContent = recentCases;
        }

        function updatePersonsList(persons) {
            const container = document.getElementById('accordion-container');

            if (persons.length === 0) {
                container.innerHTML = '<div class="no-data"><i class="fas fa-user-slash"></i><p>æœªæ‰¾åˆ°å¤±è¹¤äººå£«è³‡æ–™</p></div>';
                return;
            }

            // æŒ‰æ€§åˆ¥åˆ†çµ„
            const groupedByGender = {};
            persons.forEach(person => {
                const gender = person.gender || 'æ€§åˆ¥æœªæ˜';
                if (!groupedByGender[gender]) {
                    groupedByGender[gender] = [];
                }
                groupedByGender[gender].push(person);
            });

            // å°æ€§åˆ¥çµ„é€²è¡Œæ’åº
            const sortedGenders = Object.keys(groupedByGender).sort((a, b) => {
                if (a.includes('ç”·å­')) return -1;
                if (a.includes('å¥³å­')) return 0;
                return 1;
            });

            // ç”Ÿæˆæ‰‹é¢¨ç´HTML - æŒ‰æ€§åˆ¥åˆ†çµ„
            let accordionHTML = '';

            sortedGenders.forEach((gender, genderIndex) => {
                const personsInGender = groupedByGender[gender];

                // å°æ¯å€‹æ€§åˆ¥çµ„å…§çš„å€‹æ¡ˆæŒ‰å¤±è¹¤æ—¥æœŸæ’åºï¼ˆæœ€è¿‘çš„åœ¨å‰ï¼‰
                personsInGender.sort((a, b) => {
                    const dateA = new Date(a.mdate || 0);
                    const dateB = new Date(b.mdate || 0);
                    return dateB - dateA;
                });

                accordionHTML += `
                    <div class="gender-group" data-gender="${gender}">
                        <div class="person-item">
                            <div class="person-header gender-header" onclick="toggleGenderGroup('${gender}')">
                                <div>
                                    <i class="fas fa-user-friends" style="margin-right: 8px;"></i>
                                    <span>${gender} (${personsInGender.length}äºº)</span>
                                </div>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div id="gender-${gender}" class="gender-content" style="display:none">
                `;

                personsInGender.forEach((person, personIndex) => {
                    const caseDate = new Date(person.mdate);
                    const today = new Date();
                    const daysMissing = Math.floor((today - caseDate) / (1000 * 60 * 60 * 24));
                    const isRecent = daysMissing <= 30;

                    accordionHTML += `
                        <div class="person-item" id="person-${person.id}" style="margin-bottom: 10px;">
                            <div class="person-header" onclick="togglePerson('${person.id}')">
                                <div>
                                    <i class="fas fa-user ${isRecent ? 'fa-exclamation-circle' : 'fa-user'}" style="color: ${isRecent ? '#ef4444' : '#60a5fa'}; margin-right: 8px;"></i>
                                    <span>${person.mname || 'å§“åä¸è©³'}</span>
                                    <span class="gender-badge">${person.gender || 'æ€§åˆ¥æœªæ˜'}</span>
                                    ${isRecent ? '<span class="case-badge">30æ—¥å…§</span>' : ''}
                                    <span style="margin-left: 8px; font-size: 0.8rem; color: #94a3b8;">${person.age || '??'}æ­²</span>
                                </div>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div id="content-${person.id}" class="person-content" style="display: none;">
                                ${person.img ? `
                                <div class="image-container">
                                    <img src="${person.img}" alt="${person.mname}" class="person-image" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%234b5563'/><text x='50' y='50' font-family='Arial' font-size='24' fill='white' text-anchor='middle' dy='.3em'>?</text></svg>'; this.style.border='2px solid #94a3b8'">
                                </div>
                                ` : ''}
                                <div class="info-row">
                                    <div class="info-label">å€‹æ¡ˆç·¨è™Ÿ</div>
                                    <div class="info-value">${person.sn || 'æœªæä¾›'}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">å¤±è¹¤æ—¥æœŸ</div>
                                    <div class="info-value">${person.mdate || 'æœªæä¾›'}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">å ±æ¡ˆæ—¥æœŸ</div>
                                    <div class="info-value">${person.reporteddate || 'æœªæä¾›'}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">å¹´é½¡/æ€§åˆ¥</div>
                                    <div class="info-value">${person.age || '??'}æ­² / ${person.gender || 'æœªæä¾›'}</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">å¤–è²Œæè¿°</div>
                                    <div class="info-value">${person.face || 'æœªæä¾›'}</div>
                                </div>
                                ${person.wear && person.wear !== 'ä¸è©³' ? `
                                <div class="info-row">
                                    <div class="info-label">å¤±è¹¤æ™‚è¡£è‘—</div>
                                    <div class="info-value">${person.wear}</div>
                                </div>
                                ` : ''}
                                ${person.other ? `
                                <div class="last-seen">
                                    <div class="info-label">æœ€å¾Œå‡ºç¾æƒ…æ³</div>
                                    <div class="info-value">${person.other}</div>
                                </div>
                                ` : ''}
                                <div class="contact-info">
                                    <div class="info-label">è¯çµ¡è­¦æ–¹</div>
                                    <div class="info-value">${person.other2 || 'è‹¥ä»»ä½•äººæœ‰å¤±è¹¤è€…çš„æ¶ˆæ¯ï¼Œè«‹ç«‹å³é€šçŸ¥è­¦æ–¹'}</div>
                                </div>
                                <div style="text-align: center; margin-top: 15px;">
                                    <button onclick="viewOnMap('${person.id}')" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-map-marker-alt" style="margin-right: 5px;"></i>æŸ¥çœ‹åœ°åœ–ä½ç½®
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                accordionHTML += `
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = accordionHTML;
        }

        function toggleGenderGroup(gender) {
            const genderContent = document.getElementById(`gender-${gender}`);
            const header = genderContent.previousElementSibling;
            const icon = header.querySelector('.fa-chevron-down, .fa-chevron-up');

            if (genderContent.style.display === 'none') {
                genderContent.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                genderContent.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        function togglePerson(personId) {
            const content = document.getElementById(`content-${personId}`);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.fa-chevron-down, .fa-chevron-up');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        function highlightPerson(personId) {
            // æ»¾å‹•åˆ°å°æ‡‰çš„å¤±è¹¤äººå£«
            const personElement = document.getElementById(`person-${personId}`);
            if (personElement) {
                // å…ˆå±•é–‹æ‰€æœ‰ä¸Šå±¤å®¹å™¨
                expandAllParentContainers(personElement);

                // æ»¾å‹•åˆ°å…ƒç´ 
                personElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // å±•é–‹è©²äººå£«çš„è©³ç´°ä¿¡æ¯
                const content = document.getElementById(`content-${personId}`);
                const header = content.previousElementSibling;
                const icon = header.querySelector('.fa-chevron-down');

                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    if (icon) icon.className = 'fas fa-chevron-up';
                }

                // é«˜äº®é¡¯ç¤ºåˆ—è¡¨é …ç›®
                personElement.style.boxShadow = '0 0 0 2px #3b82f6';
                personElement.style.transition = 'box-shadow 0.3s ease';
                setTimeout(() => {
                    personElement.style.boxShadow = '';
                }, 2000);
            }

            // åœ¨åœ°åœ–ä¸Šé«˜äº®å°æ‡‰çš„æ¨™è¨˜
            markersLayer.eachLayer(layer => {
                if (layer.id === personId) {
                    if (selectedMarker && selectedMarker !== layer) {
                        const personData = selectedMarker.personData;
                        selectedMarker.setIcon(L.divIcon({
                            className: 'person-marker',
                            html: `<div style="background-color: ${personData.gender?.includes('å¥³å­') ? '#ec4899' : '#3b82f6'}; width: 100%; height: 100%; border-radius: 50%; border: 2px solid white;"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10],
                            popupAnchor: [0, -10]
                        }));
                    }

                    layer.setIcon(L.divIcon({
                        className: 'person-marker selected',
                        html: '<div style="background-color: #ef4444; width: 100%; height: 100%; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [25, 25],
                        iconAnchor: [12.5, 12.5],
                        popupAnchor: [0, -12.5]
                    }));

                    selectedMarker = layer;
                }
            });
        }

        function viewOnMap(personId) {
            highlightPerson(personId);

            // åœ¨åœ°åœ–ä¸Šå®šä½åˆ°è©²äººå£«
            markersLayer.eachLayer(layer => {
                if (layer.id === personId) {
                    const coordinates = layer.getLatLng();
                    map.setView(coordinates, 15, { animate: true });
                    layer.openPopup();
                }
            });
        }

        function expandAllParentContainers(element) {
            // å±•é–‹æ‰€æœ‰çˆ¶ç´šå®¹å™¨ï¼ˆæ€§åˆ¥åˆ†çµ„ï¼‰
            let currentElement = element.parentElement;
            while (currentElement) {
                if (currentElement.classList.contains('gender-content')) {
                    const genderId = currentElement.id.replace('gender-', '');
                    const genderHeader = currentElement.previousElementSibling;
                    const genderIcon = genderHeader.querySelector('.fa-chevron-down, .fa-chevron-up');

                    if (currentElement.style.display === 'none') {
                        currentElement.style.display = 'block';
                        if (genderIcon) genderIcon.className = 'fas fa-chevron-up';
                    }
                }

                currentElement = currentElement.parentElement;
                // Stop if we reach the accordion container
                if (currentElement && currentElement.id === 'accordion-container') {
                    break;
                }
            }
        }

        function showNotification(message, type = 'info') {
            // ç§»é™¤ç¾æœ‰é€šçŸ¥
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // å‰µå»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;

            // è¨­å®šé€šçŸ¥æ¨£å¼
            Object.assign(notification.style, {
                position: 'fixed',
                bottom: '20px',
                right: '20px',
                backgroundColor: type === 'success' ? '#10b981' : '#3b82f6',
                color: 'white',
                padding: '12px 20px',
                borderRadius: '8px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                display: 'flex',
                alignItems: 'center',
                gap: '10px',
                zIndex: '3000',
                animation: 'slideIn 0.3s ease-out'
            });

            // æ·»åŠ åˆ°æ–‡æª”
            document.body.appendChild(notification);

            // æ·»åŠ CSSå‹•ç•«
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            // 3ç§’å¾Œç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // é¦–æ¬¡åŠ è¼‰é¡¯ç¤ºæ•™ç¨‹
        if (!localStorage.getItem('missingPersonsTutorialShown')) {
            setTimeout(() => {
                alert("æ­¡è¿ä½¿ç”¨å¤±è¹¤äººå£«æŸ¥è©¢ç³»çµ±ï¼\n\nâ€¢ ç³»çµ±é¡¯ç¤ºé¦™æ¸¯è­¦å‹™è™•æä¾›çš„å¤±è¹¤äººå£«è³‡æ–™\nâ€¢ é»æ“Šåœ°åœ–ä¸Šçš„æ¨™è¨˜å¯æŸ¥çœ‹è©³ç´°è³‡è¨Š\nâ€¢ é»æ“Šåˆ—è¡¨ä¸­çš„å§“åå¯å±•é–‹/æ”¶èµ·è©³ç´°è³‡è¨Š\nâ€¢ å€‹æ¡ˆæŒ‰æ€§åˆ¥åˆ†çµ„é¡¯ç¤º\nâ€¢ 30æ—¥å…§çš„æ–°å¢å€‹æ¡ˆæœƒæœ‰ç‰¹åˆ¥æ¨™è¨˜\nâ€¢ å¯é»æ“Šã€ŒæŸ¥çœ‹åœ°åœ–ä½ç½®ã€æŒ‰éˆ•å¿«é€Ÿå®šä½");
                localStorage.setItem('missingPersonsTutorialShown', 'true');
            }, 1000);
        }
    </script>
</body>

</html>
